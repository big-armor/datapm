# Creating DataPM Connectors

This guide describes DataPM Connectors, and how to create them.

## Quick Start

The code for connectors is located in the [client-lib/src/connector](src/connector) directory. There you can find many example connectors for reference.

Before testing your connector, you will have to add it to the [ConnectorUtil.ts](src/connector/ConnectorUtil.ts) file.

Use the following commands to run the client without first compiling.

```bash
# Be in the "client" top level directory
cd client

# This will let you choose a source connector, package, or file you want to use as a source.
# The -- is an escape in case you need to use --flags in your test command
npm run start -- fetch
```

Be sure to [write tests](#write-tests).

## Important Notes

Do not use `console.log(...)`. Instead, use the `jobContext.print(...)` function.

JobContext also contains methods for prompting the user for input, and getting information about where the job is being run. Jobs may be run not only in the client, but on the server, and other contexts in the future.

Also be aware that while Connectors are implemented as classes, you can not expect a single instance of a class to be re-used across multiple jobs, or even in the same job. This is why the same configuration and jobContext arguments are spread across the method arguments. Treat each method call as independent from all other method calls - even though they are in the same class.

## Descriptor Class Pattern

In DataPM, Description classes are used to ensure that heavy dependency loading is delayed until it is needed. Description classes should contain only basic information and simple logic - and should not import any heavy dependencies.

In DataPM parlance, a class that implements the [ConnectorDescription](src/connector/Connector.ts) interface is the top level object for a connector implementation. This class describes the basics and where to find the descriptions and implementations of the Source and/or Sink.

ConnectorDescription also defines where to find the implementation of the [Connector](src/connector/Connector.ts) class. A class that implements the Connector interface defines how to connect and authenticate to a Repository - and this logic is used by both the Source and Sink implementations.

## Connectors

A Connector in DataPM is primarily used to prompt the user for "connectionConfiguration" and "credentialsConfiguration" values. These values are used by the Source and/or Sink implementations to connect to the data repository. The Connector interface also methods to verify that the connection and credentials are valid.

## Sources

Sources are responsible for producing one or more StreamSets. Each StreamSet contains one or more Streams. Each stream produces zero or more Records. Each Record is assigned to one and only one [Schema](#schemas).

StreamSets may produce a list of Streams, or a may use a "moveToNextStream()" iterator pattern to produce Streams. An example of a StreamSet is a set of files in a single data set, or a partitioned set of tables in a database.

## Schemas

A Schema defines the properties and value types of a record. Each property has one or more value types (number, string, boolean, etc).

Schemas are generated by DataPM automatically during the "inspection" phase of the Package job.

## Sinks

A [Sink](src/connector/Sink.ts) is responsible for writing a single stream of records. All records in the stream will be for a single schema.

# Write Tests

If it is reasonably possible, write a test for your connector in the [client/test/integration](../client/test/integration/) directory. A good test fully exercises the connector by reading and/or writing data. Your test can include docker containers for dependent services like databases. See the [PostgreSQL Sink](../client/test/integration/test-postgres-sink.ts) or [PostgreSQL Source] (../client/test/integration/test-postgres-source.ts) for an examples.
